----------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  C:\Users\dafrb\Desktop\EAM_data\CHINA-SCHOCK/logs/02_prepare_23 Nov 2025.log
  log type:  text
 opened on:  23 Nov 2025, 00:17:19

. 
. *------------------------------------------------------------------------------*
. * Load panel and merge with deflators
. *------------------------------------------------------------------------------*
. 
. use "$clean_dir/panel_eam_1992_2023.dta", clear

. 
. local n_obs_initial = _N

. distinct firm_id

--------------------------------
         |     total   distinct
---------+----------------------
 firm_id |    254790      20009
--------------------------------

. local n_firms_initial = r(ndistinct)

. 
. * Merge with deflators
. merge m:1 year using "$clean_dir/deflators_colombia_1992_2023.dta", ///
>     keepusing(ipp_manuf_deflator ipp_inter_deflator ipp_cap_deflator ipc_deflator)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           254,790  (_merge==3)
    -----------------------------------------

. 
. assert _merge == 3

. drop _merge

. 
. *------------------------------------------------------------------------------*
. * Define key economic variables from EAM
. *------------------------------------------------------------------------------*
. 
. * Output: Production value (gross output)
. * Use PRODBR2 (producciÃ³n bruta) as primary measure
. gen output_nominal = PRODBR2

. label variable output_nominal "Gross output (nominal pesos)"

. 
. * Alternative: Sales (VALORVEN) if production missing
. replace output_nominal = VALORVEN if missing(output_nominal) & !missing(VALORVEN)
(0 real changes made)

. 
. * Capital: Fixed assets stock
. gen capital_nominal = ACTIVFI
(240 missing values generated)

. label variable capital_nominal "Fixed assets stock (nominal pesos)"

. 
. * Labor: Average employment (permanent + temporary)
. * PPERYTEM = Promedio personal permanente y temporal
. gen labor = PPERYTEM

. label variable labor "Average employment (permanent + temporary)"

. 
. * Alternative: Total personnel if PPERYTEM missing
. replace labor = PERTOTAL if missing(labor) & !missing(PERTOTAL)
(0 real changes made)

. 
. * Intermediate inputs: Materials and energy
. gen intermediates_nominal = CONSIN2

. label variable intermediates_nominal "Intermediate inputs (nominal pesos)"

. 
. * Labor costs: Salaries and benefits
. gen labor_cost_nominal = SALPEYTE

. label variable labor_cost_nominal "Total labor costs (nominal pesos)"

. 
. * Alternative: Only permanent workers if total missing
. replace labor_cost_nominal = SALARPER + PRESSPER if missing(labor_cost_nominal) ///
>     & !missing(SALARPER) & !missing(PRESSPER)
(0 real changes made)

. 
. *------------------------------------------------------------------------------*
. * Deflate monetary variables using differentiated deflators
. *------------------------------------------------------------------------------*
. 
. * Output and sales: IPP Manufacturing
. gen output_real = output_nominal / ipp_manuf_deflator

. label variable output_real "Gross output (real, pesos 2018)"

. 
. * Intermediate inputs: IPP Intermediate consumption
. gen intermediates_real = intermediates_nominal / ipp_inter_deflator

. label variable intermediates_real "Intermediate inputs (real, pesos 2018)"

. 
. * Capital: IPP Capital goods
. gen capital_real = capital_nominal / ipp_cap_deflator
(240 missing values generated)

. label variable capital_real "Capital stock (real, pesos 2018)"

. 
. * Labor costs: CPI Total
. gen labor_cost_real = labor_cost_nominal / ipc_deflator

. label variable labor_cost_real "Labor costs (real, pesos 2018)"

. 
. * Value added (real)
. gen va_real = output_real - intermediates_real

. label variable va_real "Value added (real, pesos 2018)"

. 
. *------------------------------------------------------------------------------*
. * Quality checks - Missing values
. *------------------------------------------------------------------------------*
. 
. * Count missing observations in key variables
. local key_vars "output_real capital_real labor intermediates_real"

. 
. * Store missing counts in locals first
. local i = 1

. foreach var of local key_vars {
  2.     quietly count if missing(`var')
  3.     local miss_`i' = r(N)
  4.     local miss_pct_`i' = (r(N) / `n_obs_initial') * 100
  5.     local i = `i' + 1
  6. }

. 
. * Create report dataset
. preserve

. clear

. set obs 4
Number of observations (_N) was 0, now 4.

. gen str30 variable = ""
(4 missing values generated)

. gen missing_count = .
(4 missing values generated)

. gen missing_pct = .
(4 missing values generated)

. 
. local i = 1

. foreach var of local key_vars {
  2.     replace variable = "`var'" in `i'
  3.     replace missing_count = `miss_`i'' in `i'
  4.     replace missing_pct = `miss_pct_`i'' in `i'
  5.     local i = `i' + 1
  6. }
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)

. 
. list, clean noobs

              variable   missi~nt   missi~ct  
           output_real          0          0  
          capital_real        240   .0941952  
                 labor          0          0  
    intermediates_real          0          0  

. export delimited using "$output_dir/missing_values_report.csv", replace
file C:\Users\dafrb\Desktop\EAM_data\CHINA-SCHOCK/output/missing_values_report.csv saved

. restore

. 
. * Drop observations with missing key production variables
. gen missing_any = missing(output_real) | missing(capital_real) | ///
>                   missing(labor) | missing(intermediates_real)

. 
. quietly count if missing_any == 1

. local n_missing = r(N)

. 
. drop if missing_any == 1
(240 observations deleted)

. drop missing_any

. 
. *------------------------------------------------------------------------------*
. * Quality checks - Zeros and negatives
. *------------------------------------------------------------------------------*
. 
. * Identify problematic observations
. gen zero_negative = (output_real <= 0) | (capital_real <= 0) | ///
>                     (labor <= 0) | (intermediates_real <= 0)

. 
. quietly count if zero_negative == 1

. local n_zero_neg = r(N)

. 
. drop if zero_negative == 1
(36,669 observations deleted)

. drop zero_negative

. 
. *------------------------------------------------------------------------------*
. * Quality checks - Accounting identities
. *------------------------------------------------------------------------------*
. 
. * Intermediate inputs should not exceed gross output
. gen m_exceeds_y = (intermediates_real > output_real)

. quietly count if m_exceeds_y == 1

. local n_m_exceeds = r(N)

. drop if m_exceeds_y == 1
(2,006 observations deleted)

. drop m_exceeds_y

. 
. * Value added should be positive
. gen va_negative = (va_real <= 0)

. quietly count if va_negative == 1

. local n_va_neg = r(N)

. drop if va_negative == 1
(1 observation deleted)

. drop va_negative

. 
. *------------------------------------------------------------------------------*
. * Quality checks - Extreme outliers
. *------------------------------------------------------------------------------*
. 
. * Winsorize at 1st and 99th percentiles by industry-year
. * Use CIIU 2-digit as industry definition
. 
. foreach var in output_real capital_real labor intermediates_real va_real {
  2.     * Calculate percentiles by industry-year
.     egen p1_`var' = pctile(`var'), p(1) by(ciiu_2d year)
  3.     egen p99_`var' = pctile(`var'), p(99) by(ciiu_2d year)
  4.     
.     * Flag outliers
.     gen outlier_`var' = (`var' < p1_`var') | (`var' > p99_`var')
  5.     
.     * Winsorize
.     replace `var' = p1_`var' if `var' < p1_`var' & !missing(`var')
  6.     replace `var' = p99_`var' if `var' > p99_`var' & !missing(`var')
  7.     
.     drop p1_`var' p99_`var'
  8. }
(1,890 real changes made)
(1,468 real changes made)
(1,890 real changes made)
(1,482 real changes made)
(1,015 real changes made)
(1,542 real changes made)
(1,890 real changes made)
(1,473 real changes made)
(1,890 real changes made)
(1,462 real changes made)

. 
. * Identify observations with any outlier
. egen any_outlier = rowtotal(outlier_*)

. replace any_outlier = (any_outlier > 0)
(3,213 real changes made)

. 
. quietly count if any_outlier == 1

. local n_outliers = r(N)

. 
. * Keep outlier flags for reference but don't drop
. * (winsorization already applied)
. drop outlier_* any_outlier

. 
. *------------------------------------------------------------------------------*
. * Create log transformations for production function estimation
. *------------------------------------------------------------------------------*
. 
. gen ln_output = ln(output_real)

. gen ln_capital = ln(capital_real)

. gen ln_labor = ln(labor)

. gen ln_intermediates = ln(intermediates_real)

. gen ln_va = ln(va_real)

. 
. label variable ln_output "Log gross output (real)"

. label variable ln_capital "Log capital stock (real)"

. label variable ln_labor "Log employment"

. label variable ln_intermediates "Log intermediate inputs (real)"

. label variable ln_va "Log value added (real)"

. 
. *------------------------------------------------------------------------------*
. * Create lagged variables for productivity estimation
. *------------------------------------------------------------------------------*
. 
. sort firm_id year

. xtset firm_id year

Panel variable: firm_id (unbalanced)
 Time variable: year, 1992 to 2023, but with gaps
         Delta: 1 unit

. 
. * Lags needed for LP/ACF/GNR methods
. gen ln_capital_lag = L.ln_capital
(27,963 missing values generated)

. gen ln_labor_lag = L.ln_labor
(27,963 missing values generated)

. gen ln_intermediates_lag = L.ln_intermediates
(27,963 missing values generated)

. 
. label variable ln_capital_lag "Log capital (t-1)"

. label variable ln_labor_lag "Log labor (t-1)"

. label variable ln_intermediates_lag "Log intermediates (t-1)"

. 
. *------------------------------------------------------------------------------*
. * Create additional control variables
. *------------------------------------------------------------------------------*
. 
. * Average wage (proxy for skill level)
. gen avg_wage = labor_cost_real / labor if labor > 0

. gen ln_avg_wage = ln(avg_wage)
(108 missing values generated)

. label variable avg_wage "Average wage (real, pesos 2018)"

. label variable ln_avg_wage "Log average wage"

. 
. * Capital-labor ratio (capital intensity)
. gen capital_labor = capital_real / labor if labor > 0

. gen ln_capital_labor = ln(capital_labor)

. label variable capital_labor "Capital-labor ratio"

. label variable ln_capital_labor "Log capital-labor ratio"

. 
. * Labor productivity
. gen labor_prod = output_real / labor if labor > 0

. gen ln_labor_prod = ln(labor_prod)

. label variable labor_prod "Labor productivity (output per worker)"

. label variable ln_labor_prod "Log labor productivity"

. 
. * Value added per worker
. gen va_per_worker = va_real / labor if labor > 0

. gen ln_va_per_worker = ln(va_per_worker)

. label variable va_per_worker "Value added per worker"

. label variable ln_va_per_worker "Log value added per worker"

. 
. *------------------------------------------------------------------------------*
. * Flag observations valid for TFP estimation
. *------------------------------------------------------------------------------*
. 
. * Observations must have:
. * 1. Non-missing production variables
. * 2. At least one lag (for dynamic methods)
. * 3. Valid CIIU classification
. 
. gen valid_for_tfp = !missing(ln_output) & !missing(ln_capital) & ///
>                     !missing(ln_labor) & !missing(ln_intermediates) & ///
>                     !missing(ln_capital_lag) & ///
>                     !missing(ciiu_2d)

. 
. label variable valid_for_tfp "=1 if observation can be used for TFP estimation"

. 
. quietly count if valid_for_tfp == 1

. local n_valid_tfp = r(N)

. 
. *------------------------------------------------------------------------------*
. * Industry-level statistics for TFP estimation feasibility
. *------------------------------------------------------------------------------*
. 
. * Count firms and observations by industry
. preserve

. keep if valid_for_tfp == 1
(27,963 observations deleted)

. collapse (count) n_obs=firm_id (sum) n_firms=entry, by(ciiu_2d)

. gsort -n_obs

. 
. * Minimum threshold for TFP estimation: 100 observations
. gen tfp_feasible = (n_obs >= 100)

. 
. list ciiu_2d n_obs n_firms tfp_feasible in 1/20, clean noobs

    ciiu_2d   n_obs   n_firms   tfp_fe~e  
         15   17588         0          1  
         10   17022         0          1  
         25   12561         0          1  
         18   12451         0          1  
         22   12106         0          1  
         32   11047         0          1  
         36   10209         0          1  
         31    9613         0          1  
         14    9364         0          1  
         28    9342         0          1  
         24    7714         0          1  
         20    7464         0          1  
         29    5840         0          1  
         23    5423         0          1  
         17    4727         0          1  
         21    4174         0          1  
         38    4048         0          1  
         19    3930         0          1  
         26    3859         0          1  
         35    3816         0          1  

. export delimited using "$output_dir/industry_sample_sizes.csv", replace
file C:\Users\dafrb\Desktop\EAM_data\CHINA-SCHOCK/output/industry_sample_sizes.csv saved

. restore

. 
. *------------------------------------------------------------------------------*
. * Create year indicators for China shock analysis
. *------------------------------------------------------------------------------*
. 
. gen pre_wto = (year < 2001)

. gen post_wto = (year >= 2001)

. gen wto_year = (year == 2001)

. 
. label variable pre_wto "=1 if year before China WTO accession"

. label variable post_wto "=1 if year after China WTO accession (2001+)"

. label variable wto_year "=1 if year 2001 (China WTO accession)"

. 
. * Time periods for analysis
. gen period = .
(215,874 missing values generated)

. replace period = 1 if year >= 1992 & year <= 2000  // Pre-WTO
(37,492 real changes made)

. replace period = 2 if year >= 2001 & year <= 2010  // Early post-WTO
(74,049 real changes made)

. replace period = 3 if year >= 2011 & year <= 2023  // Late post-WTO
(104,333 real changes made)

. 
. label define period_lbl 1 "1992-2000: Pre-WTO" 2 "2001-2010: Early post-WTO" ///
>                         3 "2011-2023: Late post-WTO"

. label values period period_lbl

. label variable period "Analysis period"

. 
. *------------------------------------------------------------------------------*
. * Organize variables and compress
. *------------------------------------------------------------------------------*
. 
. order firm_id year ciiu ciiu_2d ciiu_3d ///
>       output_real capital_real labor intermediates_real va_real ///
>       ln_output ln_capital ln_labor ln_intermediates ln_va ///
>       ln_capital_lag ln_labor_lag ln_intermediates_lag ///
>       labor_prod va_per_worker avg_wage capital_labor ///
>       valid_for_tfp pre_wto post_wto period ///
>       first_year last_year firm_age entry exit balanced

. 
. compress
  variable valid_for_tfp was float now byte
  variable pre_wto was float now byte
  variable post_wto was float now byte
  variable period was float now byte
  variable wto_year was float now byte
  (3,238,110 bytes saved)

. 
. *------------------------------------------------------------------------------*
. * Save cleaned panel
. *------------------------------------------------------------------------------*
. 
. notes: Panel prepared for productivity analysis

. notes: Base year for deflation: 2018

. notes: Differentiated deflation applied (Eslava et al. 2004)

. notes: Outliers winsorized at 1st and 99th percentiles by industry-year

. notes: Processed: `c(current_date)'

. 
. save "$clean_dir/panel_eam_clean.dta", replace
file C:\Users\dafrb\Desktop\EAM_data\CHINA-SCHOCK/processed/panel_eam_clean.dta saved

. 
. *------------------------------------------------------------------------------*
. * Generate data quality report
. *------------------------------------------------------------------------------*
. 
. * Calculate final statistics before creating report dataset
. quietly: use "$clean_dir/panel_eam_clean.dta", clear

. local n_obs_final = _N

. quietly: distinct firm_id

. local n_firms_final = r(ndistinct)

. 
. * Now create report dataset
. preserve

. clear

. set obs 10
Number of observations (_N) was 0, now 10.

. 
. gen str40 check = ""
(10 missing values generated)

. gen value = .
(10 missing values generated)

. 
. replace check = "Initial observations" in 1
(1 real change made)

. replace value = `n_obs_initial' in 1
(1 real change made)

. 
. replace check = "Dropped: missing key vars" in 2
(1 real change made)

. replace value = `n_missing' in 2
(1 real change made)

. 
. replace check = "Dropped: zeros/negatives" in 3
(1 real change made)

. replace value = `n_zero_neg' in 3
(1 real change made)

. 
. replace check = "Dropped: M > Y" in 4
(1 real change made)

. replace value = `n_m_exceeds' in 4
(1 real change made)

. 
. replace check = "Dropped: VA <= 0" in 5
(1 real change made)

. replace value = `n_va_neg' in 5
(1 real change made)

. 
. replace check = "Winsorized (outliers)" in 6
(1 real change made)

. replace value = `n_outliers' in 6
(1 real change made)

. 
. replace check = "Final observations" in 7
(1 real change made)

. replace value = `n_obs_final' in 7
(1 real change made)

. 
. replace check = "Final firms" in 8
(1 real change made)

. replace value = `n_firms_final' in 8
(1 real change made)

. 
. replace check = "Valid for TFP estimation" in 9
(1 real change made)

. replace value = `n_valid_tfp' in 9
(1 real change made)

. 
. gen pct_retained = (value / `n_obs_initial') * 100 if inlist(_n, 7, 9)
(8 missing values generated)

. 
. list, clean noobs separator(6)

                        check    value   pct_re~d  
         Initial observations   254790          .  
    Dropped: missing key vars      240          .  
     Dropped: zeros/negatives    36669          .  
               Dropped: M > Y     2006          .  
             Dropped: VA <= 0        1          .  
        Winsorized (outliers)    10485          .  
           Final observations   215874   84.72624  
                  Final firms    19143          .  
     Valid for TFP estimation   187911   73.75133  
                                     .          .  

. export delimited using "$output_dir/data_quality_report.csv", replace
file C:\Users\dafrb\Desktop\EAM_data\CHINA-SCHOCK/output/data_quality_report.csv saved

. restore

. 
. *------------------------------------------------------------------------------*
. * Summary statistics by period
. *------------------------------------------------------------------------------*
. 
. use "$clean_dir/panel_eam_clean.dta", clear

. 
. preserve

. collapse (mean) mean_output=output_real mean_capital=capital_real ///
>               mean_labor=labor mean_va=va_real ///
>               mean_labor_prod=labor_prod ///
>          (median) med_output=output_real med_labor=labor ///
>          (sd) sd_output=output_real sd_labor=labor ///
>          (count) n_obs=firm_id, ///
>          by(period)

. 
. list, clean noobs

                       period   mean_o~t   mean_c~l   mean_l~r    mean_va   mean_l~d   med_ou~t   med_la~r   sd_out~t   sd_labor    n_ob
> s  
           1992-2000: Pre-WTO   2.01e+07   1.01e+07   65.07025    8375226   984662.9    2687967         26   5.23e+07   109.8422    3749
> 2  
    2001-2010: Early post-WTO   1.87e+07   1.09e+07   58.95958    7632884   273522.6    2528435         24   6.03e+07   100.5209    7404
> 9  
     2011-2023: Late post-WTO   3.01e+07   1.77e+07    68.4129   1.14e+07   563010.2    3201547         28   1.41e+08   115.9646   10433
> 3  

. export delimited using "$output_dir/summary_by_period.csv", replace
file C:\Users\dafrb\Desktop\EAM_data\CHINA-SCHOCK/output/summary_by_period.csv saved

. restore

. 
. *------------------------------------------------------------------------------*
. * Final verification
. *------------------------------------------------------------------------------*
. 
. * Verify xtset works
. xtset firm_id year

Panel variable: firm_id (unbalanced)
 Time variable: year, 1992 to 2023, but with gaps
         Delta: 1 unit

. xtdescribe

 firm_id:  1, 2, ..., 20009                                  n =      19143
    year:  1992, 1993, ..., 2023                             T =         32
           Delta(year) = 1 unit
           Span(year)  = 32 periods
           (firm_id*year uniquely identifies each observation)

Distribution of T_i:   min      5%     25%       50%       75%     95%     max
                         1       1       3         9        17      27      32

     Freq.  Percent    Cum. |  Pattern
 ---------------------------+----------------------------------
     1497      7.82    7.82 |  111.............................
      685      3.58   11.40 |  111.....111111111111111111111111
      660      3.45   14.85 |  .................111111111111111
      581      3.04   17.88 |  1...............................
      541      2.83   20.71 |  ..................11111111111111
      538      2.81   23.52 |  11..............................
      391      2.04   25.56 |  ................1111111111111111
      338      1.77   27.33 |  ........111111111111111111111111
      293      1.53   28.86 |  11111111111111111111111111111111
    13619     71.14  100.00 | (other patterns)
 ---------------------------+----------------------------------
    19143    100.00         |  XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX

. 
. * Check for duplicates
. duplicates report firm_id year

Duplicates in terms of firm_id year

--------------------------------------
   Copies | Observations       Surplus
----------+---------------------------
        1 |       215874             0
--------------------------------------

. assert r(N) == r(unique_value)

. 
. * Verify key variables non-missing for valid_for_tfp observations
. assert !missing(ln_output) if valid_for_tfp == 1

. assert !missing(ln_capital) if valid_for_tfp == 1

. assert !missing(ln_labor) if valid_for_tfp == 1

. assert !missing(ln_intermediates) if valid_for_tfp == 1

. assert !missing(ciiu_2d) if valid_for_tfp == 1

. 
. log close
      name:  <unnamed>
       log:  C:\Users\dafrb\Desktop\EAM_data\CHINA-SCHOCK/logs/02_prepare_23 Nov 2025.log
  log type:  text
 closed on:  23 Nov 2025, 00:17:27
----------------------------------------------------------------------------------------------------------------------------------------
