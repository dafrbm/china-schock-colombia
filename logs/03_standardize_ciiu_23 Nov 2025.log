----------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  C:\Users\dafrb\Desktop\EAM_data\CHINA-SCHOCK/logs/03_standardize_ciiu_23 Nov 2025.log
  log type:  text
 opened on:  23 Nov 2025, 00:17:27

. 
. *==============================================================================*
. * PART 1: BUILD ISIC VERSION CONCORDANCES
. *==============================================================================*
. 
. *------------------------------------------------------------------------------*
. * ISIC Rev 2 -> Rev 3
. *------------------------------------------------------------------------------*
. 
. import delimited "$concordance_dir/ISIC3-ISIC2.txt", clear varnames(1)
(encoding automatically selected: ISO-8859-1)
(5 vars, 586 obs)

. 
. keep isic3 isic2

. drop if missing(isic3) | missing(isic2)
(0 observations deleted)

. duplicates drop

Duplicates in terms of all variables

(1 observation deleted)

. destring isic2 isic3, replace force
isic2 already numeric; no replace
isic3 already numeric; no replace

. 
. save "$concordance_dir/isic2_isic3_concordance.dta", replace
file C:\Users\dafrb\Desktop\EAM_data\CHINA-SCHOCK/raw_data/concordance/isic2_isic3_concordance.dta saved

. 
. *------------------------------------------------------------------------------*
. * ISIC Rev 3 -> Rev 3.1
. *------------------------------------------------------------------------------*
. 
. import delimited "$concordance_dir/ISIC_Rev_31-ISIC_Rev_3_correspondence.txt", clear varnames(1)
(encoding automatically selected: ISO-8859-1)
(5 vars, 316 obs)

. 
. rename rev31 isic31

. rename rev3 isic3

. 
. keep isic3 isic31

. drop if missing(isic3) | missing(isic31)
(0 observations deleted)

. duplicates drop

Duplicates in terms of all variables

(0 observations are duplicates)

. destring isic3 isic31, replace force
isic3: contains nonnumeric characters; replaced as int
(2 missing values generated)
isic31 already numeric; no replace

. 
. save "$concordance_dir/isic3_isic31_concordance.dta", replace
file C:\Users\dafrb\Desktop\EAM_data\CHINA-SCHOCK/raw_data/concordance/isic3_isic31_concordance.dta saved

. 
. *------------------------------------------------------------------------------*
. * ISIC Rev 3.1 -> Rev 4
. *------------------------------------------------------------------------------*
. 
. import delimited "$concordance_dir/ISIC4_ISIC31.txt", clear varnames(1)
(encoding automatically selected: ISO-8859-1)
(5 vars, 737 obs)

. 
. rename isic4code isic4

. rename isic31code isic31

. 
. keep isic31 isic4

. drop if missing(isic31) | missing(isic4)
(0 observations deleted)

. duplicates drop

Duplicates in terms of all variables

(0 observations are duplicates)

. destring isic31 isic4, replace force
isic31 already numeric; no replace
isic4 already numeric; no replace

. 
. save "$concordance_dir/isic31_isic4_concordance.dta", replace
file C:\Users\dafrb\Desktop\EAM_data\CHINA-SCHOCK/raw_data/concordance/isic31_isic4_concordance.dta saved

. 
. *==============================================================================*
. * PART 2: BUILD COMBINED CONCORDANCES TO REV 4
. *==============================================================================*
. 
. *------------------------------------------------------------------------------*
. * Rev 2 -> Rev 4 (via Rev 3 and Rev 3.1)
. *------------------------------------------------------------------------------*
. 
. use "$concordance_dir/isic2_isic3_concordance.dta", clear

. 
. merge m:m isic3 using "$concordance_dir/isic3_isic31_concordance.dta", ///
>     keep(match master) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               593  
    -----------------------------------------

. 
. merge m:m isic31 using "$concordance_dir/isic31_isic4_concordance.dta", ///
>     keep(match master) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               836  
    -----------------------------------------

. 
. bysort isic2 isic4: gen n = _N

. bysort isic2: egen max_n = max(n)

. keep if n == max_n
(380 observations deleted)

. bysort isic2 (isic4): keep if _n == 1
(297 observations deleted)

. 
. keep isic2 isic4

. rename isic2 ciiu_original

. rename isic4 ciiu_rev4

. 
. gen ciiu_rev4_4d = ciiu_rev4

. gen ciiu_rev4_3d = floor(ciiu_rev4/10)

. gen ciiu_rev4_2d = floor(ciiu_rev4/100)

. gen source_revision = 2

. 
. save "$concordance_dir/ciiu_rev2_to_rev4.dta", replace
file C:\Users\dafrb\Desktop\EAM_data\CHINA-SCHOCK/raw_data/concordance/ciiu_rev2_to_rev4.dta saved

. 
. *------------------------------------------------------------------------------*
. * Rev 3 -> Rev 4 (via Rev 3.1)
. *------------------------------------------------------------------------------*
. 
. use "$concordance_dir/isic3_isic31_concordance.dta", clear

. 
. merge m:m isic31 using "$concordance_dir/isic31_isic4_concordance.dta", ///
>     keep(match master) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               743  
    -----------------------------------------

. 
. bysort isic3 isic4: gen n = _N

. bysort isic3: egen max_n = max(n)

. keep if n == max_n
(37 observations deleted)

. bysort isic3 (isic4): keep if _n == 1
(413 observations deleted)

. 
. keep isic3 isic4

. rename isic3 ciiu_original

. rename isic4 ciiu_rev4

. 
. gen ciiu_rev4_4d = ciiu_rev4

. gen ciiu_rev4_3d = floor(ciiu_rev4/10)

. gen ciiu_rev4_2d = floor(ciiu_rev4/100)

. gen source_revision = 3

. 
. save "$concordance_dir/ciiu_rev3_to_rev4.dta", replace
file C:\Users\dafrb\Desktop\EAM_data\CHINA-SCHOCK/raw_data/concordance/ciiu_rev3_to_rev4.dta saved

. 
. *==============================================================================*
. * PART 3: HARMONIZE EAM PANEL
. *==============================================================================*
. 
. use "$clean_dir/panel_eam_clean.dta", clear

. 
. *------------------------------------------------------------------------------*
. * Identify CIIU revision used in each observation
. *------------------------------------------------------------------------------*
. 
. gen ciiu_revision = .
(215,874 missing values generated)

. 
. * Parse from ciiu_source variable which contains the original variable name
. * Examples: "CIIU4AC", "CIIU3AC", "CIIU2N4", "CIUU2", etc.
. 
. * Rev 4: Contains "4" after CIIU/CIUU
. replace ciiu_revision = 4 if regexm(ciiu_source, "[CI]+U+[24]") & regexm(ciiu_source, "4")
(108,284 real changes made)

. 
. * Rev 3: Contains "3" after CIIU/CIUU
. replace ciiu_revision = 3 if regexm(ciiu_source, "[CI]+U+[23]") & regexm(ciiu_source, "3") & missing(ciiu_revision)
(76,880 real changes made)

. 
. * Rev 2: Contains "2" after CIIU/CIUU (but not if already Rev 4)
. replace ciiu_revision = 2 if regexm(ciiu_source, "[CI]+U+2") & missing(ciiu_revision)
(14,927 real changes made)

. 
. * If still missing, try to infer from year (EAM documentation)
. * Rev 2: 1992-2000 (approximately)
. * Rev 3: 2001-2011 (approximately)  
. * Rev 4: 2012+ (approximately)
. replace ciiu_revision = 2 if missing(ciiu_revision) & year <= 2000
(0 real changes made)

. replace ciiu_revision = 3 if missing(ciiu_revision) & year >= 2001 & year <= 2011
(6,675 real changes made)

. replace ciiu_revision = 4 if missing(ciiu_revision) & year >= 2012
(9,108 real changes made)

. 
. label variable ciiu_revision "CIIU/ISIC revision used (2, 3, or 4)"

. 
. * Verify we captured revisions
. tab ciiu_revision, missing

  CIIU/ISIC |
   revision |
used (2, 3, |
      or 4) |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |     14,927        6.91        6.91
          3 |     83,555       38.71       45.62
          4 |    117,392       54.38      100.00
------------+-----------------------------------
      Total |    215,874      100.00

. 
. * Show examples of ciiu_source patterns by revision
. preserve

.     bysort ciiu_revision: gen n = _n

.     keep if n <= 3
(215,865 observations deleted)

.     list ciiu_revision ciiu_source year ciiu in 1/9, separator(0) abbreviate(20)

     +-------------------------------------------+
     | ciiu_revision   ciiu_source   year   ciiu |
     |-------------------------------------------|
  1. |             2         CIIU2   1995   3849 |
  2. |             2         CIIU2   2000   3220 |
  3. |             2         CIIU2   2000   3699 |
  4. |             3         CIIU3   2003   2109 |
  5. |             3         CIIU3   2009   2411 |
  6. |             3         CIIU3   2009   1810 |
  7. |             4         CIIU4   2012   1811 |
  8. |             4         CIIU4   2015   2023 |
  9. |             4       CIIU2N4   1994     32 |
     +-------------------------------------------+

. restore

. 
. * Keep ciiu as numeric for consistency
. gen ciiu_numeric = real(ciiu)

. label variable ciiu_numeric "CIIU code (numeric)"

. 
. *------------------------------------------------------------------------------*
. * Initialize harmonized variables
. *------------------------------------------------------------------------------*
. 
. gen ciiu_rev4_4d = .
(215,874 missing values generated)

. gen ciiu_rev4_3d = .
(215,874 missing values generated)

. gen ciiu_rev4_2d = .
(215,874 missing values generated)

. 
. label variable ciiu_rev4_4d "ISIC Rev 4 - 4 digit"

. label variable ciiu_rev4_3d "ISIC Rev 4 - 3 digit"

. label variable ciiu_rev4_2d "ISIC Rev 4 - 2 digit (division)"

. 
. *------------------------------------------------------------------------------*
. * Rev 4 codes stay unchanged
. *------------------------------------------------------------------------------*
. 
. replace ciiu_rev4_4d = ciiu_numeric if ciiu_revision == 4
(117,392 real changes made)

. replace ciiu_rev4_3d = floor(ciiu_numeric/10) if ciiu_revision == 4
(117,392 real changes made)

. replace ciiu_rev4_2d = floor(ciiu_numeric/100) if ciiu_revision == 4
(117,392 real changes made)

. 
. *------------------------------------------------------------------------------*
. * Merge Rev 2 codes
. *------------------------------------------------------------------------------*
. 
. preserve

.     use "$concordance_dir/ciiu_rev2_to_rev4.dta", clear

.     
.     keep ciiu_original ciiu_rev4_4d ciiu_rev4_3d ciiu_rev4_2d

.     
.     * Create 3-digit and 2-digit versions
.     gen ciiu_3d = floor(ciiu_original/10)

.     gen ciiu_2d = floor(ciiu_original/100)

.     
.     * Save complete dataset with all versions
.     rename ciiu_original ciiu_4d

.     keep ciiu_4d ciiu_3d ciiu_2d ciiu_rev4_4d ciiu_rev4_3d ciiu_rev4_2d

.     tempfile rev2_full

.     save `rev2_full'
file C:\Users\dafrb\AppData\Local\Temp\ST_63d8_000004.tmp saved as .dta format

. restore

. 
. * Create 4-digit concordance
. preserve

.     use `rev2_full', clear

.     keep ciiu_4d ciiu_rev4_4d ciiu_rev4_3d ciiu_rev4_2d

.     rename ciiu_4d ciiu_match

.     tempfile rev2_4d

.     save `rev2_4d'
file C:\Users\dafrb\AppData\Local\Temp\ST_63d8_000006.tmp saved as .dta format

. restore

. 
. * Create 3-digit concordance
. preserve

.     use `rev2_full', clear

.     keep ciiu_3d ciiu_rev4_4d ciiu_rev4_3d ciiu_rev4_2d

.     duplicates drop ciiu_3d, force

Duplicates in terms of ciiu_3d

(87 observations deleted)

.     rename ciiu_3d ciiu_match

.     tempfile rev2_3d

.     save `rev2_3d'
file C:\Users\dafrb\AppData\Local\Temp\ST_63d8_000008.tmp saved as .dta format

. restore

. 
. * Create 2-digit concordance
. preserve

.     use `rev2_full', clear

.     keep ciiu_2d ciiu_rev4_4d ciiu_rev4_3d ciiu_rev4_2d

.     duplicates drop ciiu_2d, force

Duplicates in terms of ciiu_2d

(126 observations deleted)

.     rename ciiu_2d ciiu_match

.     tempfile rev2_2d

.     save `rev2_2d'
file C:\Users\dafrb\AppData\Local\Temp\ST_63d8_00000a.tmp saved as .dta format

. restore

. 
. * For panel data: try matches at different levels
. gen ciiu_match = real(ciiu)

. 
. * Try 4-digit first
. merge m:1 ciiu_match using `rev2_4d', keep(master match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                       176,308
        from master                   176,308  
        from using                          0  

    Matched                            39,566  
    -----------------------------------------

. 
. * Try 3-digit for unmatched
. replace ciiu_match = floor(ciiu_match/10) if ciiu_revision == 2 & missing(ciiu_rev4_2d)
(14,927 real changes made)

. merge m:1 ciiu_match using `rev2_3d', keep(master match) nogen update

    Result                      Number of obs
    -----------------------------------------
    Not matched                       197,484
        from master                   197,484  
        from using                          0  

    Matched                                 0
        not updated                         0  
        missing updated                     0  
        nonmissing conflict                 0  
    -----------------------------------------

. 
. * Try 2-digit for still unmatched
. replace ciiu_match = floor(ciiu_match/10) if ciiu_revision == 2 & missing(ciiu_rev4_2d)
(0 real changes made)

. merge m:1 ciiu_match using `rev2_2d', keep(master match) nogen update

    Result                      Number of obs
    -----------------------------------------
    Not matched                       194,731
        from master                   194,731  
        from using                          0  

    Matched                                 0
        not updated                         0  
        missing updated                     0  
        nonmissing conflict                 0  
    -----------------------------------------

. 
. drop ciiu_match

. 
. *------------------------------------------------------------------------------*
. * Merge Rev 3 codes  
. * Note: Colombia used CIIU Rev 3 AC (Adapted) with more granular codes than
. *       standard ISIC Rev 3. For Colombian-specific 4-digit codes, we map to
. *       3-digit ISIC class level.
. *------------------------------------------------------------------------------*
. 
. preserve

.     use "$concordance_dir/ciiu_rev3_to_rev4.dta", clear

.     
.     keep ciiu_original ciiu_rev4_4d ciiu_rev4_3d ciiu_rev4_2d

.     
.     * Create 3-digit version (class level)
.     gen ciiu_3d = floor(ciiu_original/10)
(1 missing value generated)

.     
.     * Save complete dataset with both versions
.     rename ciiu_original ciiu_4d

.     keep ciiu_4d ciiu_3d ciiu_rev4_4d ciiu_rev4_3d ciiu_rev4_2d

.     tempfile rev3_full

.     save `rev3_full'
file C:\Users\dafrb\AppData\Local\Temp\ST_63d8_00000c.tmp saved as .dta format

. restore

. 
. * Create 4-digit concordance
. preserve

.     use `rev3_full', clear

.     keep ciiu_4d ciiu_rev4_4d ciiu_rev4_3d ciiu_rev4_2d

.     rename ciiu_4d ciiu_match

.     tempfile rev3_4d

.     save `rev3_4d'
file C:\Users\dafrb\AppData\Local\Temp\ST_63d8_00000e.tmp saved as .dta format

. restore

. 
. * Create 3-digit concordance for Colombian AC codes
. preserve

.     use `rev3_full', clear

.     keep ciiu_3d ciiu_rev4_4d ciiu_rev4_3d ciiu_rev4_2d

.     duplicates drop ciiu_3d, force

Duplicates in terms of ciiu_3d

(133 observations deleted)

.     rename ciiu_3d ciiu_match

.     tempfile rev3_3d

.     save `rev3_3d'
file C:\Users\dafrb\AppData\Local\Temp\ST_63d8_00000g.tmp saved as .dta format

. restore

. 
. * For panel data: try 4-digit match first
. gen ciiu_match = real(ciiu)

. merge m:1 ciiu_match using `rev3_4d', keep(master match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                       107,185
        from master                   107,185  
        from using                          0  

    Matched                            87,546  
    -----------------------------------------

. 
. * For unmatched, try 3-digit (for CIIU AC codes)
. replace ciiu_match = floor(ciiu_match/10) if ciiu_revision == 3 & missing(ciiu_rev4_2d)
(83,555 real changes made)

. merge m:1 ciiu_match using `rev3_3d', keep(master match) nogen update

    Result                      Number of obs
    -----------------------------------------
    Not matched                       118,584
        from master                   118,584  
        from using                          0  

    Matched                                 0
        not updated                         0  
        missing updated                     0  
        nonmissing conflict                 0  
    -----------------------------------------

. 
. drop ciiu_match

. 
. *==============================================================================*
. * PART 4: QUALITY CHECKS AND SUMMARY STATISTICS
. *==============================================================================*
. 
. *------------------------------------------------------------------------------*
. * Harmonization match rates by source revision
. *------------------------------------------------------------------------------*
. 
. preserve

.     gen harmonized = !missing(ciiu_rev4_2d)

.     
.     collapse (count) n_total=harmonized ///
>              (sum) n_harmonized=harmonized ///
>              (mean) match_rate=harmonized, ///
>              by(ciiu_revision)

.     
.     gen pct_harmonized = match_rate * 100

.     format match_rate %9.4f

.     format pct_harmonized %9.2f

.     
.     label variable ciiu_revision "Source CIIU revision"

.     label variable n_total "Total observations"

.     label variable n_harmonized "Successfully harmonized"

.     label variable match_rate "Match rate"

.     label variable pct_harmonized "Percent harmonized"

.     
.     list, separator(0) abbreviate(20)

     +----------------------------------------------------------------------+
     | ciiu_revision   n_total   n_harmonized   match_rate   pct_harmonized |
     |----------------------------------------------------------------------|
  1. |             3      8325              0       0.0000             0.00 |
  2. |             4    110259         110259       1.0000           100.00 |
     +----------------------------------------------------------------------+

.     
.     export delimited using "$output_dir/ciiu_harmonization_summary.csv", replace
file C:\Users\dafrb\Desktop\EAM_data\CHINA-SCHOCK/output/ciiu_harmonization_summary.csv saved

. restore

. 
. *------------------------------------------------------------------------------*
. * Sample sizes by harmonized 2-digit codes (manufacturing only)
. *------------------------------------------------------------------------------*
. 
. preserve

.     keep if ciiu_rev4_2d >= 10 & ciiu_rev4_2d <= 33
(17,087 observations deleted)

.     
.     collapse (count) n_obs=firm_id ///
>              (mean) mean_year=year, ///
>              by(ciiu_rev4_2d)

.     
.     gsort -n_obs

.     
.     label variable ciiu_rev4_2d "ISIC Rev 4 - 2 digit"

.     label variable n_obs "Number of observations"

.     label variable mean_year "Mean year"

.     
.     list, separator(0) abbreviate(20)

     +----------------------------------+
     | ciiu_rev4_2d   n_obs   mean_year |
     |----------------------------------|
  1. |           10   17570    2017.255 |
  2. |           32   11543    2008.016 |
  3. |           14    9462    2016.956 |
  4. |           22    7738    2017.178 |
  5. |           31    7542    2005.672 |
  6. |           25    6968    2016.976 |
  7. |           20    5837    2017.498 |
  8. |           23    5391    2017.242 |
  9. |           18    4856    2016.879 |
 10. |           28    4554    2016.735 |
 11. |           15    3237    2016.865 |
 12. |           13    2821    2017.128 |
 13. |           21    2225    2017.241 |
 14. |           16    1824     2016.84 |
 15. |           29    1779    2017.001 |
 16. |           27    1618    2017.481 |
 17. |           24    1568    2017.213 |
 18. |           17    1548    2017.427 |
 19. |           33    1075    1994.294 |
 20. |           19    1070    2017.825 |
 21. |           11     844    2017.135 |
 22. |           30     380    2017.563 |
 23. |           26      47    2013.511 |
     +----------------------------------+

.     
.     export delimited using "$output_dir/sample_size_harmonized_2d.csv", replace
file C:\Users\dafrb\Desktop\EAM_data\CHINA-SCHOCK/output/sample_size_harmonized_2d.csv saved

. restore

. 
. *------------------------------------------------------------------------------*
. * Sample sizes by harmonized 3-digit codes (manufacturing only)
. *------------------------------------------------------------------------------*
. 
. preserve

.     keep if ciiu_rev4_2d >= 10 & ciiu_rev4_2d <= 33
(17,087 observations deleted)

.     
.     collapse (count) n_obs=firm_id, by(ciiu_rev4_3d)

.     
.     gsort -n_obs

.     
.     label variable ciiu_rev4_3d "ISIC Rev 4 - 3 digit"

.     label variable n_obs "Number of observations"

.     
.     export delimited using "$output_dir/sample_size_harmonized_3d.csv", replace
file C:\Users\dafrb\Desktop\EAM_data\CHINA-SCHOCK/output/sample_size_harmonized_3d.csv saved

. restore

. 
. *==============================================================================*
. * PART 5: SAVE HARMONIZED PANEL
. *==============================================================================*
. 
. sort firm_id year

. 
. compress
  variable ciiu_revision was float now byte
  variable ciiu_numeric was float now int
  variable ciiu_rev4_4d was float now int
  variable ciiu_rev4_3d was float now int
  variable ciiu_rev4_2d was float now byte
  variable ciiu_2d_original was str4 now str2
  (1,660,176 bytes saved)

. save "$clean_dir/panel_eam_harmonized.dta", replace
file C:\Users\dafrb\Desktop\EAM_data\CHINA-SCHOCK/processed/panel_eam_harmonized.dta saved

. 
. log close
      name:  <unnamed>
       log:  C:\Users\dafrb\Desktop\EAM_data\CHINA-SCHOCK/logs/03_standardize_ciiu_23 Nov 2025.log
  log type:  text
 closed on:  23 Nov 2025, 00:17:32
----------------------------------------------------------------------------------------------------------------------------------------
